# 시드별 맵 시각화 가이드

## 🗺️ 개요

MetaDrive는 **시드(seed)를 기반으로 절차적 생성(procedural generation)**을 사용하여 맵을 만듭니다. 같은 시드는 항상 같은 맵을 생성하므로, 실험의 재현성이 보장됩니다.

---

## 🎯 왜 시드별 맵이 중요한가?

### 1. 일반화 성능 평가
- **학습 시드 (1000)**: 에이전트가 학습한 맵
- **테스트 시드 (2000-2004)**: 에이전트가 처음 보는 맵
- 성능 차이 = 일반화 능력

### 2. 난이도 차이
- 직선이 많은 맵 → 쉬움
- 커브와 교차로가 많은 맵 → 어려움
- 시드마다 난이도가 다름

### 3. 과적합 진단
- 학습 시드에서만 성공률이 높다면 → 과적합
- 모든 시드에서 고르게 성공한다면 → 일반화 성공

---

## 🚀 사용법

### 기본 사용

```bash
# 모든 시드 맵 비교 (1000, 2000-2004)
./venv_pgdrive/bin/python visualize_maps.py

# 결과 저장
./venv_pgdrive/bin/python visualize_maps.py --save
```

**출력**:
- 각 시드별 블록 구성 시각화
- 블록 타입 요약 (S, C, X 등)
- 맵 구조 비교

### 특정 시드만 확인

```bash
# 학습 시드와 첫 번째 테스트 시드만
./venv_pgdrive/bin/python visualize_maps.py --seeds 1000 2000

# 여러 시드 확인
./venv_pgdrive/bin/python visualize_maps.py --seeds 1000 2001 2002
```

### 난이도 분석

```bash
# 시드별 난이도 비교
./venv_pgdrive/bin/python visualize_maps.py --difficulty --save
```

**분석 내용**:
- 블록 타입 분포 (직선, 커브, 교차로)
- 난이도 점수 계산
- 시드별 난이도 비교 그래프

---

## 📊 블록 타입 설명

### 블록 타입 약어

| 약어 | 블록 타입 | 설명 | 난이도 |
|------|----------|------|--------|
| **S** | Straight | 직선 도로 | ⭐ (쉬움) |
| **C** | Circular/Curve | 커브 도로 | ⭐⭐ (보통) |
| **r** | InRamp | 진입로 | ⭐⭐ (보통) |
| **R** | OutRamp | 출구 | ⭐⭐ (보통) |
| **O** | Roundabout | 로터리 | ⭐⭐⭐⭐ (어려움) |
| **X** | Intersection | 교차로 | ⭐⭐⭐ (어려움) |
| **T** | TIntersection | T자 교차로 | ⭐⭐⭐ (어려움) |

### 예시

```
시드 1000: SCSCS (직선-커브-직선-커브-직선)
시드 2000: CSCSC (커브-직선-커브-직선-커브)
시드 2001: XSSSS (교차로-직선-직선-직선-직선)
```

---

## 🔍 실제 사용 예시

### 예시 1: 기본 맵 비교

```bash
./venv_pgdrive/bin/python visualize_maps.py
```

**출력 예시**:
```
============================================================
🗺️  시드별 맵 비교
============================================================

🔍 시드 1000 분석 중...
   블록 구성: SCSCS

🔍 시드 2000 분석 중...
   블록 구성: CSCSC

🔍 시드 2001 분석 중...
   블록 구성: SSSSS

🔍 시드 2002 분석 중...
   블록 구성: CCCCC

🔍 시드 2003 분석 중...
   블록 구성: SCSXS

🔍 시드 2004 분석 중...
   블록 구성: XSCSX

============================================================
📊 맵 구성 요약
============================================================
시드 1000: SCSCS      (5개 블록)
시드 2000: CSCSC      (5개 블록)
시드 2001: SSSSS      (5개 블록)
시드 2002: CCCCC      (5개 블록)
시드 2003: SCSXS      (5개 블록)
시드 2004: XSCSX      (5개 블록)
============================================================

📖 블록 타입 설명:
  S: Straight (직선)
  C: Circular/Curve (커브)
  r: InRamp (진입로)
  R: OutRamp (출구)
  O: Roundabout (로터리)
  X: Intersection (교차로)
  T: TIntersection (T자 교차로)
```

### 예시 2: 난이도 분석

```bash
./venv_pgdrive/bin/python visualize_maps.py --difficulty
```

**출력 예시**:
```
============================================================
📊 시드별 난이도 분석
============================================================

분석 중: 시드 1000...
  직선: 3개
  커브: 2개
  교차로: 0개
  난이도 점수: 4

분석 중: 시드 2000...
  직선: 2개
  커브: 3개
  교차로: 0개
  난이도 점수: 6

분석 중: 시드 2001...
  직선: 5개
  커브: 0개
  교차로: 0개
  난이도 점수: 0

분석 중: 시드 2002...
  직선: 0개
  커브: 5개
  교차로: 0개
  난이도 점수: 10

분석 중: 시드 2003...
  직선: 3개
  커브: 1개
  교차로: 1개
  난이도 점수: 5

분석 중: 시드 2004...
  직선: 2개
  커브: 1개
  교차로: 2개
  난이도 점수: 8
```

---

## 📈 난이도 점수 계산

### 점수 체계

```python
난이도 점수 = (커브 수 × 2) + (교차로 수 × 3) + (로터리 수 × 4)
```

### 난이도 등급

| 점수 | 등급 | 색상 | 설명 |
|------|------|------|------|
| 0-4 | Easy | 🟢 초록 | 직선 위주, 초보자 친화적 |
| 5-9 | Medium | 🟠 주황 | 커브와 직선 혼합 |
| 10+ | Hard | 🔴 빨강 | 교차로/로터리 포함, 어려움 |

---

## 💡 실전 활용

### 1. 학습 시드 선택

```bash
# 여러 시드 난이도 확인
./venv_pgdrive/bin/python visualize_maps.py --seeds 1000 1001 1002 1003 --difficulty

# 가장 쉬운 시드로 학습 시작
python train.py --mode fixed --algorithm ppo
```

**팁**: 처음에는 난이도가 낮은 시드(직선 많음)로 학습하는 것이 좋습니다.

### 2. 일반화 성능 분석

```bash
# 1. 맵 구조 확인
./venv_pgdrive/bin/python visualize_maps.py --save

# 2. 평가 실행
./venv_pgdrive/bin/python evaluate.py --model models/ppo_fixed_seed_1000.zip

# 3. 결과 분석
./venv_pgdrive/bin/python debug_results.py --results results/evaluation_results.json
```

**분석 포인트**:
- 학습 시드와 비슷한 구조의 테스트 시드에서 성공률이 높은가?
- 완전히 다른 구조의 시드에서도 성공하는가?

### 3. 과적합 진단

```python
# 평가 결과와 맵 구조 비교
시드 1000 (SCSCS): 성공률 80% ← 학습 시드
시드 2000 (CSCSC): 성공률 75% ← 비슷한 구조
시드 2001 (SSSSS): 성공률 90% ← 더 쉬운 구조
시드 2002 (CCCCC): 성공률 60% ← 더 어려운 구조
시드 2003 (SCSXS): 성공률 40% ← 교차로 포함
시드 2004 (XSCSX): 성공률 30% ← 교차로 많음
```

**결론**:
- 직선이 많으면 성공률 ↑
- 교차로가 있으면 성공률 ↓
- 학습 시드와 다른 패턴에서 성능 저하 → 과적합 가능성

---

## 🎯 맵 구조와 성능의 관계

### 관찰된 패턴

| 맵 구조 | 예상 성공률 | 이유 |
|---------|-----------|------|
| SSSSS | 90%+ | 직선만 있어서 쉬움 |
| SCSCS | 70-80% | 직선과 커브 균형 |
| CCCCC | 50-60% | 커브만 있어서 어려움 |
| SCSXS | 40-50% | 교차로 포함 |
| XSCSX | 30-40% | 교차로 여러 개 |

### 실제 데이터 (예시)

```
# 평가 결과 (evaluation_results.json)
시드 1000 (SCSCS): 보상 20.53, 성공률 0%
시드 2000 (CSCSC): 보상 14.75, 성공률 0%
시드 2001 (SSSSS): 보상 -2.50, 성공률 0%  ← 가장 쉬운데도 실패
시드 2002 (CCCCC): 보상 3.40,  성공률 0%
시드 2003 (SCSXS): 보상 -2.45, 성공률 0%
시드 2004 (XSCSX): 보상 52.73, 성공률 0%
```

**분석**: 모든 시드에서 성공률 0% → 학습이 충분하지 않음

---

## 🔧 고급 활용

### 커스텀 맵 생성

```python
# config.py 수정
FIXED_SEED_ENV_CONFIG = {
    "map": "SCSCS",  # 특정 블록 시퀀스 지정
    # 또는
    "map": 7,  # 7개 블록 (더 긴 맵)
}
```

### 특정 블록 타입 테스트

```bash
# 교차로가 많은 시드 찾기
./venv_pgdrive/bin/python visualize_maps.py --seeds 2000 2001 2002 2003 2004 --difficulty

# 해당 시드로 평가
./venv_pgdrive/bin/python evaluate.py --model models/ppo_fixed_seed_1000.zip --seeds 2003 2004
```

---

## 📁 생성되는 파일

### 맵 비교 이미지
- **파일**: `results/seed_maps_comparison.png`
- **내용**: 각 시드별 블록 구성 시각화

### 난이도 비교 이미지
- **파일**: `results/seed_difficulty_comparison.png`
- **내용**: 
  - 블록 타입 분포 그래프
  - 난이도 점수 비교 그래프

---

## 💡 팁

### 1. 학습 전 맵 확인
```bash
# 학습 시작 전에 맵 구조 확인
./venv_pgdrive/bin/python visualize_maps.py --seeds 1000
```

### 2. 테스트 시드 선택
```bash
# 다양한 난이도의 테스트 시드 선택
./venv_pgdrive/bin/python visualize_maps.py --difficulty
```

### 3. 결과 해석
- 맵 구조와 성공률을 함께 분석
- 난이도가 높은 시드에서 성능 저하는 자연스러움
- 학습 시드와 비슷한 구조에서도 실패한다면 → 학습 부족

---

## 🎓 실험 아이디어

### 실험 1: 난이도별 성능 비교
```bash
# 1. 쉬운 시드에서 학습
python train.py --mode fixed --algorithm ppo  # 시드 1000 (SSSSS)

# 2. 다양한 난이도 시드에서 평가
python evaluate.py --model models/ppo_fixed_seed_1000.zip

# 3. 맵 구조와 성능 비교
python visualize_maps.py --difficulty
python visualize.py --results results/evaluation_results.json
```

### 실험 2: 맵 타입별 일반화
```bash
# 직선 위주 시드에서 학습 → 커브 위주 시드에서 평가
# 커브 위주 시드에서 학습 → 직선 위주 시드에서 평가
```

---

## 📞 문의

맵 시각화 관련 문제가 있으면:
1. MetaDrive 환경이 제대로 설치되었는지 확인
2. `quick_start.py --demo`로 환경 테스트
3. 로그 확인

---

**Happy Mapping! 🗺️🚗**
